<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Flow - Video Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            margin-bottom: 20px;
            background: #000;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
        }

        /* Make sure the player container is hidden until the video loads */
        #player {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #player.loaded {
            opacity: 1;
        }

        /* Recording controls styles */
        .recording-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .recording-controls button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .recording-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .recording-controls button i {
            margin-right: 5px;
        }

        /* Audio player styles */
        audio {
            width: 100%;
            height: 36px;
            margin-top: 8px;
            border-radius: 8px;
            background-color: rgba(var(--primary-rgb), 0.1);
        }

        audio::-webkit-media-controls-panel {
            background-color: rgba(var(--primary-rgb), 0.1);
        }

        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display {
            color: var(--text-color);
        }

        /* Note item styles for voice notes */
        .note-item {
            background: rgba(var(--primary-rgb), 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            transition: transform 0.3s ease;
        }

        .note-item:hover {
            transform: translateX(5px);
        }

        .note-timestamp {
            font-size: 0.9rem;
            color: var(--primary-color);
            cursor: pointer;
            margin-bottom: 5px;
        }

        .note-text {
            margin-bottom: 8px;
        }

        .note-delete {
            color: var(--danger-color);
            cursor: pointer;
            float: right;
            margin-top: 5px;
        }

        /* Watch history styles */
        .watch-history-item {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
            transition: transform 0.2s;
        }
        
        .watch-history-item:hover {
            transform: translateX(5px);
        }
        
        .watch-history-thumbnail {
            width: 80px;
            height: 45px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .watch-history-info {
            max-width: calc(100% - 120px);
        }
        
        .watch-history-info h6 {
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #notesList {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
            margin-right: -8px;
            scrollbar-width: thin;
        }

        #notesList::-webkit-scrollbar {
            width: 6px;
        }

        #notesList::-webkit-scrollbar-track {
            background: var(--card-bg);
            border-radius: 10px;
        }

        #notesList::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        #notesList::-webkit-scrollbar-thumb:hover {
            background: var(--primary-hover-color);
        }

        .note-actions {
            opacity: 1;
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .note-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .note-item:hover {
            transform: translateX(5px);
        }

        .note-text {
            color: var(--text-color);
            font-size: 1rem;
            line-height: 1.5;
            margin: 8px 0;
            word-wrap: break-word;
        }

        .note-timestamp {
            font-size: 0.9rem;
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 5px;
        }

        .edit-note-form {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
        }

        .edit-note-form textarea {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            width: 100%;
            padding: 8px;
            resize: vertical;
            min-height: 60px;
        }

        .edit-note-form textarea:focus {
            background: var(--input-bg);
            color: var(--text-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
        }

        .note-actions button {
            flex: 1;
            min-width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .note-actions button i {
            font-size: 0.9rem;
        }

        [data-bs-theme="light"] .note-item {
            background: #ffffff;
            border: 1px solid #e0e0e0;
        }

        [data-bs-theme="light"] .note-text {
            color: #333333;
        }

        [data-bs-theme="light"] .note-timestamp {
            color: var(--primary-color);
        }

        [data-bs-theme="light"] #notesList::-webkit-scrollbar-track {
            background: #f0f0f0;
        }

        [data-bs-theme="dark"] .note-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        [data-bs-theme="dark"] .note-text {
            color: #e0e0e0;
        }

        [data-bs-theme="dark"] #notesList::-webkit-scrollbar-track {
            background: var(--card-bg);
        }

        /* Add styles for tasks list */
        #tasksList {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
            margin-right: -8px;
            scrollbar-width: thin;
        }

        #tasksList::-webkit-scrollbar {
            width: 6px;
        }

        #tasksList::-webkit-scrollbar-track {
            background: var(--card-bg);
            border-radius: 10px;
        }

        #tasksList::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        #tasksList::-webkit-scrollbar-thumb:hover {
            background: var(--primary-hover-color);
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: transform 0.2s ease;
        }

        .task-item:hover {
            transform: translateX(5px);
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .task-checkbox.checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .task-checkbox.checked i {
            color: white;
            font-size: 12px;
        }

        .task-text {
            flex: 1;
            font-size: 0.95rem;
            color: var(--text-color);
            word-break: break-word;
            margin: 0;
            line-height: 1.4;
        }

        .task-text.completed {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .task-delete {
            color: var(--danger-color);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .task-delete:hover {
            background-color: rgba(var(--danger-rgb), 0.1);
        }

        [data-bs-theme="light"] .task-item {
            background: #ffffff;
            border: 1px solid #e0e0e0;
        }

        [data-bs-theme="light"] .task-text {
            color: #333333;
        }

        [data-bs-theme="light"] .task-text.completed {
            color: #888888;
        }

        [data-bs-theme="dark"] .task-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        [data-bs-theme="dark"] .task-text {
            color: #e0e0e0;
        }

        [data-bs-theme="dark"] .task-text.completed {
            color: #666666;
        }

        [data-bs-theme="dark"] #tasksList::-webkit-scrollbar-track {
            background: var(--card-bg);
        }

        [data-bs-theme="light"] #tasksList::-webkit-scrollbar-track {
            background: #f0f0f0;
        }

        /* Add styles for date display */
        .note-date {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .task-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .task-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        [data-bs-theme="light"] .note-date,
        [data-bs-theme="light"] .task-date {
            color: #666666;
        }

        [data-bs-theme="dark"] .note-date,
        [data-bs-theme="dark"] .task-date {
            color: #aaaaaa;
        }

        /* Add styles for horizontal timeline layout */
        .note-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }

        .note-timestamp {
            font-size: 0.9rem;
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            padding: 2px 8px;
            background-color: rgba(var(--primary-rgb), 0.1);
            border-radius: 4px;
        }

        .note-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .note-item {
            position: relative;
            padding-left: 15px;
        }

        .note-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: var(--primary-color);
            border-radius: 3px;
        }

        [data-bs-theme="light"] .note-timestamp {
            background-color: rgba(var(--primary-rgb), 0.1);
        }

        [data-bs-theme="dark"] .note-timestamp {
            background-color: rgba(var(--primary-rgb), 0.2);
        }

        /* Add styles for playlist checkboxes */
        .form-check-input {
            width: 1.5em;
            height: 1.5em;
            margin-top: 0.2em;
            border: 2px solid var(--primary-color);
            cursor: pointer;
            transform: scale(1.2);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        [data-bs-theme="light"] .form-check-input {
            border-color: #666;
        }

        [data-bs-theme="light"] .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        [data-bs-theme="dark"] .form-check-input {
            border-color: #aaa;
        }

        [data-bs-theme="dark"] .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Increase touch area for checkboxes */
        .form-check {
            padding-left: 2.5em;
            min-height: 2em;
            display: flex;
            align-items: center;
        }

        .form-check-input {
            margin-left: -2.5em;
            margin-top: 0;
        }

        /* Add hover effect for playlist items */
        .list-group-item:hover {
            background-color: rgba(var(--primary-rgb), 0.05);
        }

        [data-bs-theme="light"] .list-group-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        [data-bs-theme="dark"] .list-group-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-book-half me-2"></i>Study Flow
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">
                    <i class="bi bi-house-door"></i>
                    Home
                </a>
            </div>
            <div class="theme-switch-wrapper ms-auto">
                <i class="bi bi-sun-fill theme-icon light-icon"></i>
                <div class="form-check form-switch ms-2 me-2">
                    <input class="form-check-input" type="checkbox" id="themeSwitch">
                </div>
                <i class="bi bi-moon-fill theme-icon dark-icon"></i>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <div class="video-container">
                    <div id="player"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <!-- Add to Playlist Button -->
                <div class="mb-4">
                    <button class="btn btn-primary w-100" id="addToPlaylistBtn">
                        <i class="bi bi-plus-circle me-2"></i>Add to Playlist
                    </button>
                </div>

                <!-- Study Notes Section -->
                <div class="notes-section mb-4">
                    <h4>Study Notes</h4>
                    <div class="mb-3">
                        <div class="input-group">
                            <textarea class="form-control" id="noteInput" rows="3" placeholder="Write your study notes here..."></textarea>
                        </div>
                        <button class="btn btn-primary mt-2 w-100" id="addNoteBtn">
                            <i class="bi bi-plus-circle me-2"></i>Add Note
                        </button>
                    </div>
                    <div class="recording-controls">
                        <button class="btn btn-danger flex-grow-1" id="recordBtn">
                            <i class="bi bi-mic-fill"></i> Start Recording
                        </button>
                        <button class="btn btn-secondary flex-grow-1" id="stopBtn" disabled>
                            <i class="bi bi-stop-fill"></i> Stop
                        </button>
                    </div>
                    <div id="notesList" class="mt-4">
                        <!-- Notes will be displayed here -->
                    </div>
                </div>

                <!-- Today's Tasks Section -->
                <div class="tasks-section mb-4">
                    <h4><i class="bi bi-check2-square"></i> Today's Tasks</h4>
                    <div class="task-input-group mb-3">
                        <input type="text" class="form-control" id="taskInput" placeholder="Add a new task...">
                        <button class="btn btn-primary mt-2 w-100" id="addTaskBtn">
                            <i class="bi bi-plus-circle me-2"></i>Add Task
                        </button>
                    </div>
                    <div id="tasksList">
                        <!-- Tasks will be displayed here -->
                    </div>
                </div>

                <!-- Performance Section -->
                <div class="performance-section">
                    <h4><i class="bi bi-graph-up"></i> Your Progress</h4>
                    <div class="progress-stats">
                        <div class="stat-card">
                            <div class="stat-label">Video Progress</div>
                            <div class="progress">
                                <div class="progress-bar" id="videoProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="stat-value" id="videoProgressText">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Study Time Today</div>
                            <div class="stat-value" id="studyTimeToday">0 min</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Notes Created</div>
                            <div class="stat-value" id="notesCount">0</div>
                        </div>
                    </div>
                </div>

                <!-- Watch History Section -->
                <div class="watch-history-section mt-4">
                    <h4><i class="bi bi-clock-history"></i> Recently Watched</h4>
                    <div id="watchHistoryList" class="mt-3">
                        <!-- Watch history will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add to Playlist Modal -->
    <div class="modal fade" id="addToPlaylistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add to Playlist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="existingPlaylists" class="mb-3">
                        <h6>Your Playlists</h6>
                        <div id="playlistsList" class="list-group">
                            <!-- Playlists will be loaded here -->
                        </div>
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-outline-primary" onclick="showCreatePlaylistModal()">
                            <i class="bi bi-plus-lg me-2"></i>Create New Playlist
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create New Playlist Modal -->
    <div class="modal fade" id="createPlaylistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Playlist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createPlaylistForm">
                        <div class="mb-3">
                            <label for="playlistName" class="form-label">Playlist Name</label>
                            <input type="text" class="form-control" id="playlistName" required>
                        </div>
                        <div class="mb-3">
                            <label for="playlistDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="playlistDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isPrivate">
                                <label class="form-check-label" for="isPrivate">
                                    Make this playlist private
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createPlaylistBtn">
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        Create Playlist
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
        import {
            saveVideoProgress,
            getVideoProgress,
            saveNotes,
            getNotes,
            saveTasks,
            getTasks,
            updateStudyTime,
            getStudyTime,
            markVideoCompleted,
            isVideoCompleted,
            addToWatchHistory,
            getLastSearch,
            getWatchHistory,
            setupRealtimeListeners
        } from './database.js';
        import { handlePlaylistSelection } from './playlistManager.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD33YiLLyTxlIycnHcArDKbgxvK_se27eA",
            authDomain: "studyflow-6ed25.firebaseapp.com",
            databaseURL: "https://studyflow-6ed25-default-rtdb.firebaseio.com",
            projectId: "studyflow-6ed25",
            storageBucket: "studyflow-6ed25.firebasestorage.app",
            messagingSenderId: "562903369542",
            appId: "1:562903369542:web:3f80ceb14d749870fc0747",
            measurementId: "G-TD7DS8YKSB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let currentUser = null;

        // YouTube player variables
        let player;
        let notes = [];
        let tasks = [];

        // Fix video ID parameter handling
        function getVideoId() {
            try {
                // First try to get from player if available
                if (window.player && window.player.getVideoData) {
                    const playerData = window.player.getVideoData();
                    if (playerData && playerData.video_id) {
                        return playerData.video_id;
                    }
                }

                // Then try URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const videoId = urlParams.get('v') || urlParams.get('id');

                // Debug logging
                console.log('Current URL:', window.location.href);
                console.log('Video ID from URL:', videoId);

                if (!videoId) {
                    console.error('No video ID found in URL');
                    return null;
                }

                return videoId;
            } catch (error) {
                console.error('Error getting video ID:', error);
                return null;
            }
        }

        // Add function to validate video exists
        async function validateVideo(videoId) {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=AIzaSyD33YiLLyTxlIycnHcArDKbgxvK_se27eA`
                );

                if (!response.ok) {
                    throw new Error('Failed to validate video');
                }

                const data = await response.json();
                return data.items && data.items.length > 0;
            } catch (error) {
                console.error('Error validating video:', error);
                return false;
            }
        }

        // Initialize YouTube player
        async function initializePlayer() {
            const videoId = getVideoId();
            if (!videoId) {
                document.querySelector('.video-container').innerHTML = `
                    <div class="alert alert-danger m-3">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        No video ID found. Please make sure you have a valid video URL.
                    </div>`;
                return;
            }

            if (!window.YT) {
                console.error('YouTube API not loaded');
                return;
            }

            try {
                window.player = new YT.Player('player', {
                    height: '360',
                    width: '640',
                    videoId: videoId,
                    playerVars: {
                        'playsinline': 1,
                        'rel': 0,
                        'modestbranding': 1,
                        'controls': 1
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange,
                        'onError': onPlayerError
                    }
                });
            } catch (error) {
                console.error('Error initializing player:', error);
                showNotification('Error loading video player', 'error');
            }
        }

        // YouTube API Ready callback
        window.onYouTubeIframeAPIReady = function() {
            if (currentUser) {
                initializePlayer();
            }
        };

        // Player Ready Event
        function onPlayerReady(event) {
            console.log('Player ready');
            document.getElementById('player').classList.add('loaded');
            
            // Start progress tracking immediately
            startProgressTracking();
            
            // Load saved progress
            loadSavedProgress();
        }

        // Load saved progress
        async function loadSavedProgress() {
            if (!currentUser || !window.player) return;

            const videoId = getVideoId();
            if (!videoId) return;
            
            try {
                const progress = await getVideoProgress(currentUser.uid, videoId);
                if (progress && progress.currentTime) {
                    // Make sure player is ready before seeking
                    if (window.player.seekTo) {
                        // Add a small buffer to prevent starting from exactly the same spot
                        const resumeTime = Math.max(0, progress.currentTime - 2);
                        window.player.seekTo(resumeTime, true);
                        window.player.playVideo();
                        
                        // Update progress bar
                        const progressPercent = (progress.currentTime / progress.duration) * 100;
                        const progressBar = document.getElementById('videoProgress');
                        const progressText = document.getElementById('videoProgressText');
                        
                        if (progressBar && progressText) {
                            progressBar.style.width = `${progressPercent}%`;
                            progressText.textContent = `${Math.round(progressPercent)}%`;
                        }

                        // Show a notification that video was resumed
                        showNotification(`Resumed from ${formatTime(resumeTime)}`, 'info');
                    } else {
                        console.log('Player not ready for seeking, will try again later');
                        // Try again after a short delay
                        setTimeout(loadSavedProgress, 1000);
                    }
                }
            } catch (error) {
                console.error('Error loading saved progress:', error);
            }
        }

        // Authentication state change handler
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await initTheme();
                
                // Initialize player if YouTube API is ready
                if (window.YT && window.YT.Player) {
                    await initializePlayer();
                }

                // Load user data
                const videoId = getVideoId();
                if (videoId) {
                    try {
                        // Load notes specifically for this video
                        const notesData = await getNotes(user.uid, videoId);
                        notes = Array.isArray(notesData) ? notesData : [];
                        displayNotes();
                        
                        // Update notes count
                        document.getElementById('notesCount').textContent = notes.length.toString();

                        // Update tasks
                        const tasksData = await getTasks(user.uid);
                        tasks = tasksData || [];
                        displayTasks();

                        // Setup real-time listeners
                        setupRealtimeListeners(user.uid, {
                            onNotesUpdate: (updatedNotes) => {
                                if (updatedNotes[videoId]) {
                                    notes = updatedNotes[videoId];
                                    displayNotes();
                                }
                            },
                            onTasksUpdate: (updatedTasks) => {
                                tasks = updatedTasks;
                                displayTasks();
                            },
                            onPerformanceUpdate: (performance) => {
                                updatePerformanceDisplay(performance);
                            }
                        });

                        // Start tracking performance
                startPerformanceTracking();
                        
                        // Add to watch history
                        addToWatchHistoryAndLoadVideo();

                    } catch (error) {
                        console.error('Error loading user data:', error);
                    }
                }
            } else {
                window.location.href = 'signin.html';
            }
        });

        // Theme switching functionality
        const themeSwitch = document.getElementById('themeSwitch');

        async function initTheme() {
            if (!currentUser) return;
            
            try {
                const settingsRef = ref(db, `users/${currentUser.uid}/settings`);
                const snapshot = await get(settingsRef);
                const settings = snapshot.val() || {};
                const theme = settings.theme || 'light';
                
                document.documentElement.setAttribute('data-bs-theme', theme);
                themeSwitch.checked = theme === 'dark';
            } catch (error) {
                console.error('Error initializing theme:', error);
                document.documentElement.setAttribute('data-bs-theme', 'light');
                themeSwitch.checked = false;
            }
        }

        async function toggleTheme() {
            if (!currentUser) return;
            
            try {
                const currentTheme = document.documentElement.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                // Update theme immediately
                document.documentElement.setAttribute('data-bs-theme', newTheme);
                
                // Save to Firebase
                const settingsRef = ref(db, `users/${currentUser.uid}/settings`);
                const snapshot = await get(settingsRef);
                const settings = snapshot.val() || {};
                settings.theme = newTheme;
                await set(settingsRef, settings);
            } catch (error) {
                console.error('Error toggling theme:', error);
            }
        }

        // Add theme switch event listener
        themeSwitch.addEventListener('change', toggleTheme);

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                // Video ended
                document.getElementById('videoProgress').style.width = '100%';
                document.getElementById('videoProgressText').textContent = '100%';
                
                // Mark video as completed
                const videoId = getVideoId();
                markVideoCompleted(currentUser.uid, videoId);
            } else if (event.data === YT.PlayerState.PLAYING) {
                // Video is playing
                startProgressTracking();
            }
        }

        function onPlayerError(event) {
            console.error('YouTube Player Error:', event.data);
            alert('Error loading video. Please check if the video ID is correct and the video is available.');
        }

        // Update progress every second
        let progressInterval;
        let lastSavedProgress = 0;
        function startProgressTracking() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            progressInterval = setInterval(updateProgress, 1000);
        }

        async function updateProgress() {
            if (window.player && window.player.getCurrentTime && window.player.getDuration) {
                try {
                    const currentTime = window.player.getCurrentTime();
                    const duration = window.player.getDuration();
                    
                    if (isNaN(currentTime) || isNaN(duration) || duration === 0) {
                        console.log('Invalid player state, skipping progress update');
                        return;
                    }
                    
                    const progress = (currentTime / duration) * 100;
                    
                    // Update progress bar
                    const progressBar = document.getElementById('videoProgress');
                    const progressText = document.getElementById('videoProgressText');
                    
                    if (progressBar && progressText) {
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${Math.round(progress)}%`;
                        
                        // Save progress to Firebase only if it's changed significantly (more than 5 seconds)
                        if (Math.abs(currentTime - lastSavedProgress) >= 5) {
                            const videoId = getVideoId();
                            if (videoId && currentUser) {
                                const progressData = {
                                    currentTime: currentTime,
                                    duration: duration,
                                    progress: progress,
                                    lastUpdated: new Date().toISOString(),
                                    videoId: videoId,
                                    title: window.player.getVideoData().title
                                };
                                await saveVideoProgress(currentUser.uid, videoId, progressData);
                                lastSavedProgress = currentTime;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error updating progress:', error);
                }
            }
        }

        // Notes functionality
        async function addNote() {
            const noteText = document.getElementById('noteInput').value.trim();
            if (!noteText || !currentUser || !window.player) return;
            
            try {
                const timestamp = window.player.getCurrentTime();
                const videoId = getVideoId();
                const now = new Date();
                
                const note = {
                    id: Date.now().toString(),
                    text: noteText,
                    timestamp: timestamp,
                    formattedTime: formatTime(timestamp),
                    createdAt: now.toISOString(),
                    formattedDate: formatDateAndTime(now)
                };
                
                // Initialize notes array if undefined
                if (!Array.isArray(notes)) {
                    notes = [];
                }
                
                // Add new note
                notes.push(note);
                
                // Clear input
                document.getElementById('noteInput').value = '';
                
                // Save to Firebase
                await saveNotes(currentUser.uid, videoId, notes);
                
                // Update display
                displayNotes();
                
                // Update notes count
                document.getElementById('notesCount').textContent = notes.length.toString();
                
                console.log('Note added successfully:', note);
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Failed to add note. Please try again.');
            }
        }

        function displayNotes() {
            const notesList = document.getElementById('notesList');
            if (!notesList || !Array.isArray(notes)) return;
            
            notesList.innerHTML = '';
            
            // Sort notes by timestamp
            const sortedNotes = [...notes].sort((a, b) => a.timestamp - b.timestamp);
            
            sortedNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item';
                
                let audioPlayer = '';
                if (note.audioData) {
                    audioPlayer = `
                        <audio controls class="mt-2 w-100">
                            <source src="${note.audioData}" type="audio/wav">
                            Your browser does not support the audio element.
                        </audio>
                    `;
                }
                
                if (editingNoteId === note.id) {
                    // Show edit form
                noteElement.innerHTML = `
                        <div class="note-header d-flex align-items-center">
                            <div class="note-timestamp" onclick="seekToTimestamp(${note.timestamp})">
                        ${note.formattedTime}
                            </div>
                            <div class="note-date ms-2">
                                ${note.formattedDate || formatDateAndTime(new Date(note.createdAt))}
                            </div>
                        </div>
                        <div class="edit-note-form">
                            <textarea class="form-control mb-2" id="editNoteText">${note.text}</textarea>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success" onclick="saveEditedNote('${note.id}')">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelEdit()">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // Show normal note view
                    noteElement.innerHTML = `
                        <div class="note-header d-flex align-items-center">
                            <div class="note-timestamp" onclick="seekToTimestamp(${note.timestamp})">
                                ${note.formattedTime}
                            </div>
                            <div class="note-date ms-2">
                                ${note.formattedDate || formatDateAndTime(new Date(note.createdAt))}
                            </div>
                    </div>
                    <div class="note-text">${note.text}</div>
                    ${audioPlayer}
                        <div class="note-actions d-flex gap-2 mt-2">
                            <button class="btn btn-sm btn-primary" onclick="seekToTimestamp(${note.timestamp})">
                                <i class="bi bi-play-fill"></i> Go to timestamp
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editNote('${note.id}')">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteNote('${note.id}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    `;
                }
                notesList.appendChild(noteElement);
            });
        }

        async function deleteNote(noteId) {
            if (!currentUser || !Array.isArray(notes)) return;

            try {
                const videoId = getVideoId();
                notes = notes.filter(note => note.id !== noteId);
                
                // Save updated notes to Firebase
                await saveNotes(currentUser.uid, videoId, notes);
                
                // Update display
        displayNotes();
                
                // Update notes count
                document.getElementById('notesCount').textContent = notes.length.toString();
                
                console.log('Note deleted successfully:', noteId);
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Failed to delete note. Please try again.');
            }
        }

        // Tasks functionality
        async function addTask(text) {
            const now = new Date();
            const task = {
                id: Date.now(),
                text: text,
                completed: false,
                date: now.toDateString(),
                createdAt: now.toISOString(),
                formattedDate: formatDateAndTime(now)
            };
            
            tasks.push(task);
            await saveTasks(currentUser.uid, tasks);
            displayTasks();
            document.getElementById('taskInput').value = '';
        }

        async function toggleTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                await saveTasks(currentUser.uid, tasks);
                displayTasks();
            }
        }

        async function deleteTask(taskId) {
            tasks = tasks.filter(t => t.id !== taskId);
            await saveTasks(currentUser.uid, tasks);
            displayTasks();
        }

        function displayTasks() {
            const tasksList = document.getElementById('tasksList');
            const todayTasks = tasks.filter(task => task.date === new Date().toDateString());
            
            tasksList.innerHTML = '';
            todayTasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                taskElement.innerHTML = `
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                        ${task.completed ? '<i class="bi bi-check"></i>' : ''}
                    </div>
                    <div class="task-content">
                    <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                        <div class="task-date">${task.formattedDate || formatDateAndTime(new Date(task.createdAt))}</div>
                    </div>
                    <i class="bi bi-trash task-delete" onclick="deleteTask(${task.id})"></i>
                `;
                tasksList.appendChild(taskElement);
            });
        }

        // Performance tracking
        let startTime = Date.now();
        let studyTimeToday = 0;

        async function startPerformanceTracking() {
            studyTimeToday = await getStudyTime(currentUser.uid);
            document.getElementById('studyTimeToday').textContent = `${studyTimeToday} min`;

            // Update performance metrics every minute
            setInterval(async () => {
                studyTimeToday = await updateStudyTime(currentUser.uid, 1);
                document.getElementById('studyTimeToday').textContent = `${studyTimeToday} min`;

                // Update notes count
                const videoId = getVideoId();
                document.getElementById('notesCount').textContent = notes.length.toString();
            }, 60000);
        }

        // Add to watch history
        async function addToWatchHistoryAndLoadVideo() {
            const videoId = getVideoId();
            if (!videoId) {
                return;
            }

            try {
                const lastSearch = await getLastSearch(currentUser.uid);
                const video = lastSearch?.results?.find(v => v.id.videoId === videoId);
                
                if (video) {
                    await addToWatchHistory(currentUser.uid, video);
                    await displayWatchHistory();
                }
            } catch (error) {
                console.error('Error adding to watch history:', error);
            }
        }

        // Display watch history
        async function displayWatchHistory() {
            const watchHistoryList = document.getElementById('watchHistoryList');
            const watchHistory = await getWatchHistory(currentUser.uid);
            
            if (!watchHistory || watchHistory.length === 0) {
                watchHistoryList.innerHTML = `
                    <div class="text-center text-muted">
                        <p>No watch history yet</p>
                    </div>
                `;
                return;
            }
            
            // Display only the last 5 watched videos
            const recentVideos = watchHistory.slice(0, 5);
            watchHistoryList.innerHTML = recentVideos.map(video => `
                <div class="watch-history-item mb-3">
                    <div class="d-flex align-items-center">
                        <img src="${video.snippet.thumbnails.default.url}" 
                             alt="${video.snippet.title}" 
                             class="watch-history-thumbnail me-2">
                        <div class="watch-history-info flex-grow-1">
                            <h6 class="mb-1">${video.snippet.title}</h6>
                            <small class="text-muted">Watched on ${new Date(video.watchedAt).toLocaleDateString()}</small>
                        </div>
                        <a href="player.html?id=${video.id.videoId}" class="btn btn-sm btn-primary">
                            <i class="bi bi-play-fill"></i>
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // Helper function to format time
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Add a helper function to format date and time
        function formatDateAndTime(date) {
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleString(undefined, options);
        }

        // Make functions globally available
        window.addNote = addNote;
        window.deleteNote = deleteNote;
        window.editNote = editNote;
        window.saveEditedNote = saveEditedNote;
        window.cancelEdit = cancelEdit;
        window.addTask = addTask;
        window.toggleTask = toggleTask;
        window.deleteTask = deleteTask;
        window.seekToTimestamp = seekToTimestamp;
        window.startRecording = startRecording;
        window.stopRecording = stopRecording;
        window.updateVideoCount = updateVideoCount;

        // Voice Recording functionality
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStream = null;

        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');

        async function startRecording() {
            try {
                if (isRecording) {
                    console.log('Already recording');
                    return;
                }

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true,
                    video: false
                });
                
                recordingStream = stream;
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                    audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    try {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const timestamp = window.player.getCurrentTime();
                    
                    // Convert audio to base64
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = async () => {
                            try {
                        const base64Audio = reader.result;
                        
                        // Create note with audio
                        const note = {
                                    id: Date.now().toString(),
                            text: ' Voice Note',
                            timestamp: timestamp,
                            formattedTime: formatTime(timestamp),
                                    audioData: base64Audio,
                                    createdAt: new Date().toISOString()
                        };
                                
                                // Initialize notes array if undefined
                                if (!Array.isArray(notes)) {
                                    notes = [];
                                }
                        
                        notes.push(note);
                        
                        // Save notes
                                const videoId = getVideoId();
                        await saveNotes(currentUser.uid, videoId, notes);
                        
                                // Update display and count
                        displayNotes();
                                document.getElementById('notesCount').textContent = notes.length.toString();
                                
                                console.log('Voice note saved successfully');
                            } catch (error) {
                                console.error('Error saving voice note:', error);
                                alert('Failed to save voice note. Please try again.');
                            }
                        };
                        
                        // Reset recording state
                    audioChunks = [];
                        const recordBtn = document.getElementById('recordBtn');
                    recordBtn.innerHTML = '<i class="bi bi-mic-fill"></i> Start Recording';
                    recordBtn.classList.remove('btn-danger');
                    recordBtn.classList.add('btn-primary');
                        document.getElementById('stopBtn').disabled = true;
                        
                        // Stop all tracks
                        if (recordingStream) {
                            recordingStream.getTracks().forEach(track => track.stop());
                            recordingStream = null;
                        }
                    } catch (error) {
                        console.error('Error processing recording:', error);
                        alert('Error processing recording. Please try again.');
                    }
                };

                mediaRecorder.start();
                isRecording = true;
                
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.innerHTML = '<i class="bi bi-record-circle"></i> Recording...';
                recordBtn.classList.remove('btn-primary');
                recordBtn.classList.add('btn-danger');
                document.getElementById('stopBtn').disabled = false;
                
                console.log('Recording started');
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Error accessing microphone. Please ensure you have granted microphone permissions and try again.');
                resetRecordingState();
            }
        }

        function stopRecording() {
            try {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                    document.getElementById('stopBtn').disabled = true;
                    
                    // Stop all tracks
                    if (recordingStream) {
                        recordingStream.getTracks().forEach(track => track.stop());
                        recordingStream = null;
                    }
                    
                    console.log('Recording stopped');
                }
            } catch (error) {
                console.error('Error stopping recording:', error);
                alert('Error stopping recording. Please try again.');
                resetRecordingState();
            }
        }

        function resetRecordingState() {
            isRecording = false;
            mediaRecorder = null;
            audioChunks = [];
            
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
                recordingStream = null;
            }
            
            const recordBtn = document.getElementById('recordBtn');
            recordBtn.innerHTML = '<i class="bi bi-mic-fill"></i> Start Recording';
            recordBtn.classList.remove('btn-danger');
            recordBtn.classList.add('btn-primary');
            document.getElementById('stopBtn').disabled = true;
        }

        // Add recording event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const recordBtn = document.getElementById('recordBtn');
            const stopBtn = document.getElementById('stopBtn');
            const addNoteBtn = document.getElementById('addNoteBtn');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const noteInput = document.getElementById('noteInput');
            const taskInput = document.getElementById('taskInput');
            
            if (recordBtn) {
        recordBtn.addEventListener('click', () => {
            if (!isRecording) {
                startRecording();
            }
        });
            }

            if (stopBtn) {
        stopBtn.addEventListener('click', stopRecording);
            }

            // Add note button click handler
            if (addNoteBtn) {
                addNoteBtn.addEventListener('click', addNote);
            }

            // Add note on Enter key press (Shift+Enter for new line)
            if (noteInput) {
                noteInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                addNote();
            }
        });
            }

            // Add task button click handler
            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', () => {
                    const taskText = taskInput.value.trim();
                    if (taskText) {
                        addTask(taskText);
                    }
                });
            }

            // Add task on Enter key press
            if (taskInput) {
                taskInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                        e.preventDefault();
                        const taskText = taskInput.value.trim();
                        if (taskText) {
                            addTask(taskText);
                }
            }
        });
            }
        });

        // Helper function to update study time display
        function updateStudyTimeDisplay(time) {
            const hours = Math.floor(time / 3600);
            const minutes = Math.floor((time % 3600) / 60);
            document.getElementById('studyTimeToday').textContent = 
                `${hours}h ${minutes}m`;
        }

        // Function to seek to timestamp
        function seekToTimestamp(timestamp) {
            if (window.player && window.player.seekTo) {
                window.player.seekTo(parseFloat(timestamp));
            }
        }

        // Add editingNoteId variable to track which note is being edited
        let editingNoteId = null;

        // Function to start editing a note
        function editNote(noteId) {
            editingNoteId = noteId;
            displayNotes();
        }

        // Function to save edited note
        async function saveEditedNote(noteId) {
            if (!currentUser) return;

            try {
                const editedText = document.getElementById('editNoteText').value.trim();
                if (!editedText) return;

                const noteIndex = notes.findIndex(note => note.id === noteId);
                if (noteIndex === -1) return;

                // Update the note text while preserving other properties
                notes[noteIndex] = {
                    ...notes[noteIndex],
                    text: editedText,
                    lastEdited: new Date().toISOString()
                };

                // Save to Firebase
                const videoId = getVideoId();
                await saveNotes(currentUser.uid, videoId, notes);

                // Reset editing state and refresh display
                editingNoteId = null;
                displayNotes();

                console.log('Note edited successfully:', noteId);
            } catch (error) {
                console.error('Error editing note:', error);
                alert('Failed to edit note. Please try again.');
            }
        }

        // Function to cancel editing
        function cancelEdit() {
            editingNoteId = null;
            displayNotes();
        }

        // Add to playlist functionality
        document.getElementById('addToPlaylistBtn').addEventListener('click', async () => {
            if (!currentUser) {
                alert('Please sign in to add videos to playlists');
                return;
            }
            
            await loadPlaylists();
            const modal = new bootstrap.Modal(document.getElementById('addToPlaylistModal'));
            modal.show();
        });

        async function loadPlaylists() {
            try {
                const playlistsRef = ref(db, `users/${currentUser.uid}/playlists`);
                const snapshot = await get(playlistsRef);
                const playlists = snapshot.val() || {};
                
                const playlistsList = document.getElementById('playlistsList');
                playlistsList.innerHTML = '';

                // Get current video ID
                let currentVideoId;
                if (window.player && window.player.getVideoData) {
                    currentVideoId = window.player.getVideoData().video_id;
                }
                if (!currentVideoId) {
                    currentVideoId = getVideoId();
                }
                
                if (Object.keys(playlists).length === 0) {
                    playlistsList.innerHTML = '<div class="text-center text-muted">No playlists found</div>';
                    return;
                }
                
                Object.values(playlists).forEach(playlist => {
                    // Check if video exists in this playlist
                    const videoExists = playlist.videos?.some(video => video.id.videoId === currentVideoId);
                    const videoCount = playlist.videos?.length || 0;
                    
                    const playlistItem = document.createElement('div');
                    playlistItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    playlistItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="playlist-info">
                                <div class="d-flex align-items-center gap-2">
                                    <h6 class="mb-1" id="playlistName_${playlist.id}">${playlist.name}</h6>
                                    <button class="btn btn-sm btn-link text-primary p-0" onclick="editPlaylistName('${playlist.id}')">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                </div>
                                <small class="text-muted" id="videoCount_${playlist.id}">${videoCount} video${videoCount !== 1 ? 's' : ''}</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                ${playlist.isPrivate ? '<i class="bi bi-lock-fill text-muted"></i>' : ''}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${playlist.id}" 
                                           id="playlist_${playlist.id}" 
                                           onchange="handlePlaylistSelection('${playlist.id}', this.checked)"
                                           ${videoExists ? 'checked' : ''}>
                                </div>
                            </div>
                        </div>
                        <div class="edit-name-form d-none" id="editForm_${playlist.id}">
                            <div class="input-group">
                                <input type="text" class="form-control form-control-sm" 
                                       id="editNameInput_${playlist.id}" 
                                       value="${playlist.name}">
                                <button class="btn btn-sm btn-success" onclick="savePlaylistName('${playlist.id}')">
                                    <i class="bi bi-check"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelEditPlaylistName('${playlist.id}')">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    playlistsList.appendChild(playlistItem);
                });
            } catch (error) {
                console.error('Error loading playlists:', error);
                showNotification('Error loading playlists', 'error');
            }
        }

        // Add functions for editing playlist name
        window.editPlaylistName = (playlistId) => {
            // Hide name display and show edit form
            const nameElement = document.getElementById(`playlistName_${playlistId}`).parentElement;
            const editForm = document.getElementById(`editForm_${playlistId}`);
            nameElement.classList.add('d-none');
            editForm.classList.remove('d-none');
            
            // Focus on input
            const input = document.getElementById(`editNameInput_${playlistId}`);
            input.focus();
            input.select();
        };

        window.savePlaylistName = async (playlistId) => {
            try {
                const newName = document.getElementById(`editNameInput_${playlistId}`).value.trim();
                if (!newName) {
                    showNotification('Playlist name cannot be empty', 'warning');
                    return;
                }

                // Update in Firebase
                const playlistRef = ref(db, `users/${currentUser.uid}/playlists/${playlistId}`);
                const snapshot = await get(playlistRef);
                const playlist = snapshot.val();
                
                if (!playlist) {
                    throw new Error('Playlist not found');
                }

                await set(ref(db, `users/${currentUser.uid}/playlists/${playlistId}/name`), newName);
                
                // Update display
                document.getElementById(`playlistName_${playlistId}`).textContent = newName;
                
                // Hide edit form
                cancelEditPlaylistName(playlistId);
                
                showNotification('Playlist name updated successfully', 'success');
            } catch (error) {
                console.error('Error updating playlist name:', error);
                showNotification('Failed to update playlist name', 'error');
            }
        };

        window.cancelEditPlaylistName = (playlistId) => {
            // Show name display and hide edit form
            const nameElement = document.getElementById(`playlistName_${playlistId}`).parentElement;
            const editForm = document.getElementById(`editForm_${playlistId}`);
            nameElement.classList.remove('d-none');
            editForm.classList.add('d-none');
        };

        // Add event listener for Enter key in edit input
        document.addEventListener('click', (e) => {
            if (e.target && e.target.id && e.target.id.startsWith('editNameInput_')) {
                const playlistId = e.target.id.replace('editNameInput_', '');
                e.target.addEventListener('keyup', async (event) => {
                    if (event.key === 'Enter') {
                        await savePlaylistName(playlistId);
                    } else if (event.key === 'Escape') {
                        cancelEditPlaylistName(playlistId);
                    }
                });
            }
        });

        // Add function to update video count display
        function updateVideoCount(playlistId, count) {
            const countElement = document.getElementById(`videoCount_${playlistId}`);
            if (countElement) {
                countElement.textContent = `${count} video${count !== 1 ? 's' : ''}`;
            }
        }

        // Update handlePlaylistSelection to handle video removal
        window.handlePlaylistSelection = async (playlistId, isChecked) => {
            if (!currentUser) {
                showNotification('Please sign in to manage playlists', 'warning');
                return;
            }

            // Get video ID from the current player
            let videoId;
            if (window.player && window.player.getVideoData) {
                videoId = window.player.getVideoData().video_id;
            }

            // Fallback to URL parameters if player data is not available
            if (!videoId) {
                videoId = getVideoId();
            }

            if (!videoId) {
                showNotification('Cannot update playlist: Video ID not found', 'error');
                // Reset checkbox state
                document.getElementById(`playlist_${playlistId}`).checked = !isChecked;
                return;
            }

            try {
                await handlePlaylistSelection(currentUser, playlistId, isChecked);
            } catch (error) {
                console.error('Error handling playlist selection:', error);
                showNotification(error.message || 'Failed to update playlist', 'error');
                // Reset checkbox state
                document.getElementById(`playlist_${playlistId}`).checked = !isChecked;
            }
        };

        // Update the showNotification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 
                                  type === 'warning' ? 'bi-exclamation-triangle-fill' : 
                                  type === 'danger' ? 'bi-x-circle-fill' : 
                                  'bi-info-circle-fill'} me-2"></i>
                    <div>${message}</div>
                    <button type="button" class="btn-close ms-2" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto dismiss after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Update the create playlist button click handler
        document.getElementById('createPlaylistBtn').addEventListener('click', async () => {
            const name = document.getElementById('playlistName').value.trim();
            const description = document.getElementById('playlistDescription').value.trim();
            const isPrivate = document.getElementById('isPrivate').checked;
            const button = document.getElementById('createPlaylistBtn');
            const spinner = button.querySelector('.spinner-border');
            
            if (!name) {
                alert('Please enter a playlist name');
                return;
            }
            
            try {
                button.disabled = true;
                spinner.classList.remove('d-none');
                button.textContent = 'Creating...';
                
                const playlist = await createPlaylist(name, description, isPrivate);
                console.log('Playlist created:', playlist);
                
                // Reset form and close modal
                document.getElementById('createPlaylistForm').reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('createPlaylistModal'));
                modal.hide();
                
                // Reload playlists list
                await loadPlaylists();
                
                // Automatically check the new playlist
                const videoId = new URLSearchParams(window.location.search).get('v');
                if (videoId) {
                    document.getElementById(`playlist_${playlist.id}`).checked = true;
                    await handlePlaylistSelection(playlist.id, true);
                }
                
                showNotification('Playlist created successfully!', 'success');
            } catch (error) {
                console.error('Error creating playlist:', error);
                alert(error.message || 'Failed to create playlist');
            } finally {
                button.disabled = false;
                spinner.classList.add('d-none');
                button.textContent = 'Create Playlist';
            }
        });

        // Make showCreatePlaylistModal function globally available
        window.showCreatePlaylistModal = () => {
            const addToPlaylistModal = bootstrap.Modal.getInstance(document.getElementById('addToPlaylistModal'));
            addToPlaylistModal.hide();
            
            const createPlaylistModal = new bootstrap.Modal(document.getElementById('createPlaylistModal'));
            createPlaylistModal.show();
        };

        // Add the createPlaylist function
        async function createPlaylist(name, description, isPrivate) {
            if (!currentUser) {
                throw new Error('Please sign in to create a playlist');
            }

            try {
                const playlistId = Date.now().toString();
                const playlist = {
                    id: playlistId,
                    name: name,
                    description: description || '',
                    isPrivate: isPrivate,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    createdBy: currentUser.uid,
                    videos: []
                };

                // Save playlist to Firebase
                const playlistRef = ref(db, `users/${currentUser.uid}/playlists/${playlistId}`);
                await set(playlistRef, playlist);

                return playlist;
            } catch (error) {
                console.error('Error creating playlist:', error);
                throw new Error('Failed to create playlist. Please try again.');
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="themeManager.js"></script>
</body>
</html> 