<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Flow - Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --profile-bg: #ffffff;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --text-muted: #6c757d;
            --border-color: rgba(0,0,0,0.125);
            --hover-bg: rgba(0,0,0,0.03);
            --stat-card-bg: #f8f9fa;
            --chart-grid: rgba(0,0,0,0.1);
        }

        [data-bs-theme="dark"] {
            --profile-bg: #1a1d21;
            --card-bg: #242830;
            --text-color: #e9ecef;
            --text-muted: #adb5bd;
            --border-color: rgba(255,255,255,0.125);
            --hover-bg: rgba(255,255,255,0.03);
            --stat-card-bg: #2a2f38;
            --chart-grid: rgba(255,255,255,0.1);
        }

        body {
            background-color: var(--profile-bg);
            color: var(--text-color);
        }

        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .profile-picture {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            border: 4px solid var(--primary-color);
        }

        .profile-name {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .profile-email {
            color: var(--text-muted);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background-color: var(--stat-card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-muted);
        }

        .activity-section {
            margin-bottom: 3rem;
        }

        .activity-section h3 {
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .activity-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .activity-card h4 {
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .activity-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.6;
        }

        .progress-section {
            margin-bottom: 3rem;
        }

        .progress-section h3 {
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .progress-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .progress-card h4 {
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        .progress-bar {
            height: 8px;
            background-color: var(--hover-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transition: width 0.3s ease;
        }

        .graph-section {
            margin-bottom: 3rem;
        }

        .graph-section h3 {
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }

        .graph-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .graph-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .graph-legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .graph-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .graph-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            background: var(--hover-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
        }

        .graph-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .graph-btn:hover {
            transform: translateY(-2px);
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            font-weight: 500;
            animation: pulse 2s infinite;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background-color: var(--primary-color);
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .graph-tooltip {
            background: var(--card-bg) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 8px !important;
            padding: 8px 12px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        }

        .graph-tooltip-title {
            color: var(--text-color) !important;
            font-weight: 600 !important;
            margin-bottom: 4px !important;
        }

        .graph-tooltip-value {
            color: var(--primary-color) !important;
            font-weight: 500 !important;
        }

        .graph-zoom-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .zoom-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            background: var(--hover-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
        }

        .zoom-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .graph-export {
            margin-top: 1rem;
            text-align: right;
        }

        .export-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            background: var(--hover-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            background: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-book-half me-2"></i>Study Flow
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">
                    <i class="bi bi-house-door"></i>
                    Home
                </a>
                    </div>
            <div class="theme-switch-wrapper ms-auto">
                <i class="bi bi-sun-fill theme-icon light-icon"></i>
                <div class="form-check form-switch ms-2 me-2">
                    <input class="form-check-input" type="checkbox" id="themeSwitch">
                </div>
                <i class="bi bi-moon-fill theme-icon dark-icon"></i>
            </div>
        </div>
    </nav>

        <div class="profile-container">
            <div class="profile-header">
                <img id="profilePicture" src="https://via.placeholder.com/150" alt="Profile Picture" class="profile-picture">
                <h1 id="profileName" class="profile-name">User Name</h1>
                <p id="profileEmail" class="profile-email">user@example.com</p>
            </div>

            <div class="profile-stats">
            <div class="stat-card">
                <div class="stat-value" id="totalStudyTime">0</div>
                <div class="stat-label">Total Study Hours</div>
            </div>
                <div class="stat-card">
                    <div class="stat-value" id="notesCount">0</div>
                    <div class="stat-label">Notes Created</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="tasksCount">0</div>
                    <div class="stat-label">Tasks Completed</div>
                </div>
                <div class="stat-card">
                <div class="stat-value" id="videosWatched">0</div>
                <div class="stat-label">Videos Watched</div>
            </div>
        </div>

        <div class="graph-section">
            <div class="graph-header">
                <h3>Study Time Analysis</h3>
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    <span>Live Updates</span>
                </div>
            </div>
            <div class="graph-controls">
                <button class="graph-btn active" data-period="week">Weekly</button>
                <button class="graph-btn" data-period="month">Monthly</button>
                <button class="graph-btn" data-period="year">Yearly</button>
                            </div>
            <div class="graph-zoom-controls">
                <button class="zoom-btn" data-action="zoom-in">+</button>
                <button class="zoom-btn" data-action="zoom-out">-</button>
                <button class="zoom-btn" data-action="reset">Reset</button>
                        </div>
            <div class="graph-container">
                <div class="graph-wrapper">
                    <canvas id="studyTimeChart"></canvas>
                </div>
            </div>
            <div class="graph-export">
                <button class="export-btn" id="exportStudyData">
                    <i class="bi bi-download"></i>
                    Export Data
                </button>
            </div>
        </div>

        <div class="graph-section">
            <div class="graph-header">
                <h3>Activity Distribution</h3>
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    <span>Live Updates</span>
                </div>
            </div>
            <div class="graph-container">
                <div class="graph-wrapper">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
            <div class="graph-legend" id="activityLegend"></div>
        </div>

        <div class="activity-section">
            <h3>Recent Activity</h3>
            <div class="activity-grid">
                <div class="activity-card">
                    <h4><i class="bi bi-journal-text me-2"></i>Recent Notes</h4>
                    <ul class="activity-list" id="recentNotes">
                        <!-- Recent notes will be displayed here -->
                    </ul>
                </div>
                <div class="activity-card">
                    <h4><i class="bi bi-check2-square me-2"></i>Recent Tasks</h4>
                    <ul class="activity-list" id="recentTasks">
                        <!-- Recent tasks will be displayed here -->
                    </ul>
                </div>
                <div class="activity-card">
                    <h4><i class="bi bi-clock-history me-2"></i>Recently Watched</h4>
                    <ul class="activity-list" id="recentVideos">
                        <!-- Recently watched videos will be displayed here -->
                    </ul>
                </div>
            </div>
        </div>

        <div class="progress-section">
            <h3>Study Progress</h3>
            <div class="progress-grid">
                <div class="progress-card">
                    <h4>Daily Study Time</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="dailyStudyProgress"></div>
                    </div>
                    <div class="stat-value" id="dailyStudyTime">0 min</div>
                </div>
                <div class="progress-card">
                    <h4>Weekly Progress</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="weeklyProgress"></div>
                    </div>
                    <div class="stat-value" id="weeklyStudyTime">0 hours</div>
                </div>
                <div class="progress-card">
                    <h4>Monthly Goals</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="monthlyProgress"></div>
                    </div>
                    <div class="stat-value" id="monthlyStudyTime">0 hours</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getDatabase, ref, get, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
        import { setupRealtimeListeners } from './database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD33YiLLyTxlIycnHcArDKbgxvK_se27eA",
            authDomain: "studyflow-6ed25.firebaseapp.com",
            databaseURL: "https://studyflow-6ed25-default-rtdb.firebaseio.com",
            projectId: "studyflow-6ed25",
            storageBucket: "studyflow-6ed25.firebasestorage.app",
            messagingSenderId: "562903369542",
            appId: "1:562903369542:web:3f80ceb14d749870fc0747",
            measurementId: "G-TD7DS8YKSB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Check authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Update profile info
                document.getElementById('profilePicture').src = user.photoURL || 'https://via.placeholder.com/150';
                document.getElementById('profileName').textContent = user.displayName || 'User';
                document.getElementById('profileEmail').textContent = user.email;

                // Setup real-time listeners
                setupRealtimeListeners(user.uid, {
                    onNotesUpdate: (notes) => {
                        updateNotesStats(notes);
                        updateRecentNotes(notes);
                    },
                    onTasksUpdate: (tasks) => {
                        updateTasksStats(tasks);
                        updateRecentTasks(tasks);
                    },
                    onPerformanceUpdate: (performance) => {
                        updatePerformanceStats(performance);
                    },
                    onWatchHistoryUpdate: (watchHistory) => {
                        updateWatchHistoryStats(watchHistory);
                        updateRecentVideos(watchHistory);
                    }
                });

                // Load initial data
                await loadInitialData(user.uid);
            } else {
                window.location.href = 'signin.html';
            }
        });

        async function loadInitialData(userId) {
            // Load all data initially
            const notesRef = ref(db, `users/${userId}/notes`);
            const tasksRef = ref(db, `users/${userId}/tasks`);
            const performanceRef = ref(db, `users/${userId}/performance`);
            const watchHistoryRef = ref(db, `users/${userId}/watchHistory`);

            const [notesSnapshot, tasksSnapshot, performanceSnapshot, watchHistorySnapshot] = await Promise.all([
                get(notesRef),
                get(tasksRef),
                get(performanceRef),
                get(watchHistoryRef)
            ]);

            const notes = notesSnapshot.val() || {};
            const tasks = tasksSnapshot.val() || [];
            const performance = performanceSnapshot.val() || {};
            const watchHistory = watchHistorySnapshot.val() || [];

            updateNotesStats(notes);
            updateTasksStats(tasks);
            updatePerformanceStats(performance);
            updateWatchHistoryStats(watchHistory);
            updateRecentNotes(notes);
            updateRecentTasks(tasks);
            updateRecentVideos(watchHistory);
        }

        function updateNotesStats(notes) {
            let totalNotes = 0;
            Object.values(notes).forEach(videoNotes => {
                totalNotes += videoNotes.length;
            });
            document.getElementById('notesCount').textContent = totalNotes;
        }

        function updateTasksStats(tasks) {
            const completedTasks = tasks.filter(task => task.completed).length;
            document.getElementById('tasksCount').textContent = completedTasks;
        }

        let studyTimeChart;
        let activityChart;
        let currentPeriod = 'week';

        function updatePerformanceStats(performance) {
            let totalStudyTime = 0;
            let dailyStudyTime = 0;
            const today = new Date().toDateString();
            
            Object.entries(performance).forEach(([date, data]) => {
                totalStudyTime += data.studyTime || 0;
                if (date === today) {
                    dailyStudyTime = data.studyTime || 0;
                }
            });

            document.getElementById('totalStudyTime').textContent = Math.round(totalStudyTime / 60);
            document.getElementById('dailyStudyTime').textContent = `${dailyStudyTime} min`;
            
            // Update progress bars
            const dailyProgress = Math.min((dailyStudyTime / 120) * 100, 100);
            const weeklyProgress = Math.min((totalStudyTime / (60 * 14)) * 100, 100);
            const monthlyProgress = Math.min((totalStudyTime / (60 * 60)) * 100, 100);

            document.getElementById('dailyStudyProgress').style.width = `${dailyProgress}%`;
            document.getElementById('weeklyProgress').style.width = `${weeklyProgress}%`;
            document.getElementById('monthlyProgress').style.width = `${monthlyProgress}%`;

            // Update charts
            updateStudyTimeChart(performance);
            updateActivityChart(performance);
        }

        function updateStudyTimeChart(performance) {
            const ctx = document.getElementById('studyTimeChart').getContext('2d');
            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
            
            // Prepare data based on selected period
            let labels = [];
            let data = [];
            const now = new Date();
            
            if (currentPeriod === 'week') {
                // Last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toDateString();
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                    data.push((performance[dateStr]?.studyTime || 0) / 60); // Convert to hours
                }
            } else if (currentPeriod === 'month') {
                // Last 30 days
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toDateString();
                    labels.push(date.toLocaleDateString('en-US', { day: 'numeric' }));
                    data.push((performance[dateStr]?.studyTime || 0) / 60);
                }
            } else {
                // Last 12 months
                for (let i = 11; i >= 0; i--) {
                    const date = new Date(now);
                    date.setMonth(date.getMonth() - i);
                    const monthStr = date.toLocaleDateString('en-US', { month: 'short' });
                    labels.push(monthStr);
                    
                    // Sum all days in the month
                    let monthTotal = 0;
                    const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayDate = new Date(date.getFullYear(), date.getMonth(), day);
                        const dayStr = dayDate.toDateString();
                        monthTotal += (performance[dayStr]?.studyTime || 0) / 60;
                    }
                    data.push(monthTotal);
                }
            }

            if (studyTimeChart) {
                studyTimeChart.destroy();
            }

            studyTimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Study Time (hours)',
                        data: data,
                        borderColor: isDark ? '#818cf8' : '#4f46e5',
                        backgroundColor: isDark ? 'rgba(129, 140, 248, 0.2)' : 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: isDark ? '#818cf8' : '#4f46e5',
                        pointBorderColor: isDark ? '#1a1d21' : 'white',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: isDark ? '#e9ecef' : '#2c3e50',
                                font: {
                                    size: 14,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? '#374151' : 'white',
                            titleColor: isDark ? '#ffffff' : '#2c3e50',
                            bodyColor: isDark ? '#ffffff' : '#2c3e50',
                            borderColor: isDark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            titleFont: {
                                size: 14,
                                weight: '600'
                            },
                            bodyFont: {
                                size: 13,
                                weight: '500'
                            },
                            callbacks: {
                                label: function(context) {
                                    return `Study Time: ${context.parsed.y.toFixed(1)} hours`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                                drawBorder: false,
                                lineWidth: 1
                            },
                            ticks: {
                                color: isDark ? '#e9ecef' : '#2c3e50',
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                padding: 8,
                                callback: function(value) {
                                    return value + ' hrs';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                                drawBorder: false,
                                lineWidth: 1
                            },
                            ticks: {
                                color: isDark ? '#e9ecef' : '#2c3e50',
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                padding: 8
                            }
                        }
                    }
                }
            });

            // Add zoom controls
            document.querySelectorAll('.zoom-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    if (action === 'zoom-in') {
                        studyTimeChart.zoom(1.1);
                    } else if (action === 'zoom-out') {
                        studyTimeChart.zoom(0.9);
                    } else if (action === 'reset') {
                        studyTimeChart.resetZoom();
                    }
                });
            });
        }

        function updateActivityChart(performance) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
            
            // Calculate activity distribution
            const activityData = {
                notes: 0,
                tasks: 0,
                videos: 0
            };

            // Count activities
            Object.values(performance).forEach(data => {
                activityData.notes += data.notesCount || 0;
                activityData.tasks += data.tasksCount || 0;
                activityData.videos += data.videosWatched || 0;
            });

            if (activityChart) {
                activityChart.destroy();
            }

            activityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Notes', 'Tasks', 'Videos'],
                    datasets: [{
                        data: [activityData.notes, activityData.tasks, activityData.videos],
                        backgroundColor: [
                            isDark ? '#818cf8' : '#4f46e5',
                            isDark ? '#ec4899' : '#db2777',
                            isDark ? '#34d399' : '#10b981'
                        ],
                        borderColor: isDark ? '#1a1d21' : 'white',
                        borderWidth: 2,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: isDark ? '#e9ecef' : '#2c3e50',
                                font: {
                                    size: 14,
                                    weight: '600'
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? '#374151' : 'white',
                            titleColor: isDark ? '#ffffff' : '#2c3e50',
                            bodyColor: isDark ? '#ffffff' : '#2c3e50',
                            borderColor: isDark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: '600'
                            },
                            bodyFont: {
                                size: 13,
                                weight: '500'
                            },
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Update legend
            const legendContainer = document.getElementById('activityLegend');
            legendContainer.innerHTML = activityChart.data.labels.map((label, i) => `
                <div class="legend-item" data-index="${i}">
                    <div class="legend-color" style="background-color: ${activityChart.data.datasets[0].backgroundColor[i]}"></div>
                    <span>${label}</span>
                </div>
            `).join('');

            // Add legend click handlers
            document.querySelectorAll('.legend-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    const meta = activityChart.getDatasetMeta(0);
                    meta.data[index].hidden = !meta.data[index].hidden;
                    activityChart.update();
                    item.classList.toggle('active');
                });
            });
        }

        // Add event listeners for graph period buttons
        document.querySelectorAll('.graph-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.graph-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPeriod = btn.dataset.period;
                updateStudyTimeChart(window.currentPerformance || {});
            });
        });

        function updateWatchHistoryStats(watchHistory) {
            document.getElementById('videosWatched').textContent = watchHistory.length;
        }

        function updateRecentNotes(notes) {
            const recentNotesList = document.getElementById('recentNotes');
            let allNotes = [];
            
            Object.entries(notes).forEach(([videoId, videoNotes]) => {
                videoNotes.forEach(note => {
                    allNotes.push({
                        ...note,
                        videoId
                    });
                });
            });

            // Sort by timestamp and get last 5
            allNotes.sort((a, b) => b.id - a.id);
            const recentNotes = allNotes.slice(0, 5);

            recentNotesList.innerHTML = recentNotes.map(note => `
                <li class="activity-item">
                    <div>${note.text}</div>
                    <small class="activity-time">${new Date(note.id).toLocaleString()}</small>
                </li>
            `).join('');
        }

        function updateRecentTasks(tasks) {
            const recentTasksList = document.getElementById('recentTasks');
            const recentTasks = tasks
                .sort((a, b) => b.id - a.id)
                .slice(0, 5);

            recentTasksList.innerHTML = recentTasks.map(task => `
                <li class="activity-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${task.text}</span>
                        <span class="badge ${task.completed ? 'bg-success' : 'bg-warning'}">
                            ${task.completed ? 'Completed' : 'Pending'}
                        </span>
                    </div>
                    <small class="activity-time">${new Date(task.id).toLocaleString()}</small>
                </li>
            `).join('');
        }

        function updateRecentVideos(watchHistory) {
            const recentVideosList = document.getElementById('recentVideos');
            const recentVideos = watchHistory.slice(0, 5);

            recentVideosList.innerHTML = recentVideos.map(video => `
                <li class="activity-item">
                    <div>${video.snippet.title}</div>
                    <small class="activity-time">${new Date(video.watchedAt).toLocaleString()}</small>
                </li>
            `).join('');
        }

        // Add export functionality
        document.getElementById('exportStudyData').addEventListener('click', () => {
            const data = {
                labels: studyTimeChart.data.labels,
                studyTime: studyTimeChart.data.datasets[0].data
            };
            
            const csv = [
                ['Date', 'Study Time (hours)'],
                ...data.labels.map((label, i) => [label, data.studyTime[i]])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `study_time_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="themeManager.js"></script>
    <script>
        // Theme switching functionality
        document.addEventListener('DOMContentLoaded', () => {
            const themeSwitch = document.getElementById('themeSwitch');
            const htmlElement = document.documentElement;
            
            // Check saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                htmlElement.setAttribute('data-bs-theme', savedTheme);
                themeSwitch.checked = savedTheme === 'dark';
            }

            // Theme switch handler
            themeSwitch.addEventListener('change', () => {
                const theme = themeSwitch.checked ? 'dark' : 'light';
                htmlElement.setAttribute('data-bs-theme', theme);
                localStorage.setItem('theme', theme);
                
                // Update chart colors if charts exist
                if (window.studyTimeChart) {
                    updateChartColors(window.studyTimeChart);
                }
                if (window.activityChart) {
                    updateChartColors(window.activityChart);
                }
            });
        });

        // Function to update chart colors based on theme
        function updateChartColors(chart) {
            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
            
            if (chart.config.type === 'line') {
                // Update line chart colors
                chart.data.datasets[0].borderColor = isDark ? '#818cf8' : '#4f46e5';
                chart.data.datasets[0].backgroundColor = isDark ? 'rgba(129, 140, 248, 0.2)' : 'rgba(79, 70, 229, 0.1)';
                chart.data.datasets[0].pointBackgroundColor = isDark ? '#818cf8' : '#4f46e5';
                chart.data.datasets[0].pointBorderColor = isDark ? '#1a1d21' : 'white';
            } else if (chart.config.type === 'doughnut') {
                // Update doughnut chart colors
                chart.data.datasets[0].backgroundColor = [
                    isDark ? '#818cf8' : '#4f46e5',
                    isDark ? '#ec4899' : '#db2777',
                    isDark ? '#34d399' : '#10b981'
                ];
                chart.data.datasets[0].borderColor = isDark ? '#1a1d21' : 'white';
            }
            
            // Update common elements
            if (chart.options.scales) {
                chart.options.scales.x.grid.color = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                chart.options.scales.y.grid.color = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                chart.options.scales.x.ticks.color = isDark ? '#e9ecef' : '#2c3e50';
                chart.options.scales.y.ticks.color = isDark ? '#e9ecef' : '#2c3e50';
            }
            
            // Update tooltips
            chart.options.plugins.tooltip.backgroundColor = isDark ? '#374151' : 'white';
            chart.options.plugins.tooltip.titleColor = isDark ? '#ffffff' : '#2c3e50';
            chart.options.plugins.tooltip.bodyColor = isDark ? '#ffffff' : '#2c3e50';
            chart.options.plugins.tooltip.borderColor = isDark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)';
            
            // Update legend
            if (chart.options.plugins.legend) {
                chart.options.plugins.legend.labels.color = isDark ? '#e9ecef' : '#2c3e50';
            }
            
            chart.update();
        }
    </script>
</body>
</html> 