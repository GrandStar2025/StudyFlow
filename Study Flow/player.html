<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Flow - Video Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-book-half me-2"></i>Study Flow
            </a>
            <div class="theme-switch-wrapper ms-auto">
                <i class="bi bi-sun-fill theme-icon light-icon"></i>
                <div class="form-check form-switch ms-2 me-2">
                    <input class="form-check-input" type="checkbox" id="themeSwitch">
                </div>
                <i class="bi bi-moon-fill theme-icon dark-icon"></i>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <div class="video-container">
                    <div id="player"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <!-- Performance Section -->
                <div class="performance-section mb-4">
                    <h4><i class="bi bi-graph-up"></i> Your Progress</h4>
                    <div class="progress-stats">
                        <div class="stat-card">
                            <div class="stat-label">Video Progress</div>
                            <div class="progress">
                                <div class="progress-bar" id="videoProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="stat-value" id="videoProgressText">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Study Time Today</div>
                            <div class="stat-value" id="studyTimeToday">0 min</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Notes Created</div>
                            <div class="stat-value" id="notesCount">0</div>
                        </div>
                    </div>
                </div>

                <!-- Today's Tasks Section -->
                <div class="tasks-section mb-4">
                    <h4><i class="bi bi-check2-square"></i> Today's Tasks</h4>
                    <div class="task-input-group mb-3">
                        <input type="text" class="form-control" id="taskInput" placeholder="Add a new task...">
                        <button class="btn btn-primary mt-2 w-100" id="addTaskBtn">
                            <i class="bi bi-plus-circle me-2"></i>Add Task
                        </button>
                    </div>
                    <div id="tasksList">
                        <!-- Tasks will be displayed here -->
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="notes-section">
                    <h4>Study Notes</h4>
                    <div class="mb-3">
                        <div class="input-group">
                            <textarea class="form-control" id="noteInput" rows="3" placeholder="Write your study notes here..."></textarea>
                        </div>
                        <button class="btn btn-primary mt-2 w-100" id="addNoteBtn">
                            <i class="bi bi-plus-circle me-2"></i>Add Note
                        </button>
                    </div>
                    <div class="recording-controls">
                        <button class="btn btn-danger flex-grow-1" id="recordBtn">
                            <i class="bi bi-mic-fill"></i> Start Recording
                        </button>
                        <button class="btn btn-secondary flex-grow-1" id="stopBtn" disabled>
                            <i class="bi bi-stop-fill"></i> Stop
                        </button>
                    </div>
                    <div id="notesList" class="mt-4">
                        <!-- Notes will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let player;
        let notes = [];
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let editingNoteId = null;

        // Initialize YouTube Player
        function onYouTubeIframeAPIReady() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('id');
            
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            // Start progress tracking
            updateProgress();
        }

        function onPlayerStateChange(event) {
            // YT.PlayerState.ENDED = 0
            if (event.data === 0) {
                // Video ended
                document.getElementById('videoProgress').style.width = '100%';
                document.getElementById('videoProgressText').textContent = '100%';
                
                // Save completion in localStorage
                const videoId = new URLSearchParams(window.location.search).get('id');
                const completedVideos = JSON.parse(localStorage.getItem('completedVideos') || '[]');
                if (!completedVideos.includes(videoId)) {
                    completedVideos.push(videoId);
                    localStorage.setItem('completedVideos', JSON.stringify(completedVideos));
                }
            }
        }

        // Update progress every 2 seconds
        function updateProgress() {
            if (player && player.getCurrentTime && player.getDuration) {
                const currentTime = player.getCurrentTime();
                const duration = player.getDuration();
                const progress = (currentTime / duration) * 100;
                
                document.getElementById('videoProgress').style.width = `${progress}%`;
                document.getElementById('videoProgressText').textContent = `${Math.round(progress)}%`;

                // Save progress in localStorage
                const videoId = new URLSearchParams(window.location.search).get('id');
                const videoProgress = {
                    id: videoId,
                    progress: progress,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem(`videoProgress_${videoId}`, JSON.stringify(videoProgress));
            }
            setTimeout(updateProgress, 2000); // Update every 2 seconds
        }

        // Load saved progress when video loads
        function loadSavedProgress() {
            const videoId = new URLSearchParams(window.location.search).get('id');
            const savedProgress = localStorage.getItem(`videoProgress_${videoId}`);
            if (savedProgress) {
                const { progress } = JSON.parse(savedProgress);
                document.getElementById('videoProgress').style.width = `${progress}%`;
                document.getElementById('videoProgressText').textContent = `${Math.round(progress)}%`;
            }
        }

        // Notes functionality
        document.getElementById('addNoteBtn').addEventListener('click', () => {
            const noteText = document.getElementById('noteInput').value.trim();
            if (noteText) {
                const currentTime = player.getCurrentTime();
                addNote(noteText, currentTime);
                document.getElementById('noteInput').value = '';
            }
        });

        function addNote(text, time) {
            const note = {
                id: Date.now(),
                text: text,
                time: time,
                timestamp: new Date().toISOString()
            };
            notes.push(note);
            saveNotes();
            displayNotes();
        }

        function displayNotes() {
            const notesList = document.getElementById('notesList');
            notesList.innerHTML = '';
            
            notes.sort((a, b) => a.time - b.time).forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item';
                noteElement.innerHTML = `
                    <div class="note-time">
                        <i class="bi bi-clock"></i>
                        ${formatTime(note.time)}
                    </div>
                    <div class="note-text" id="note-text-${note.id}">${note.text}</div>
                    ${note.audioUrl ? `
                        <audio class="audio-player" controls>
                            <source src="${note.audioUrl}" type="audio/wav">
                            Your browser does not support the audio element.
                        </audio>
                    ` : ''}
                    <div class="note-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="seekToTime(${note.time})">
                            <i class="bi bi-play-circle me-1"></i>Jump to time
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="editNote(${note.id})">
                            <i class="bi bi-pencil me-1"></i>Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteNote(${note.id})">
                            <i class="bi bi-trash me-1"></i>Delete
                        </button>
                    </div>
                `;
                notesList.appendChild(noteElement);
            });
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function seekToTime(time) {
            player.seekTo(time);
        }

        function editNote(noteId) {
            if (editingNoteId === noteId) {
                // Save the edit
                const noteTextElement = document.getElementById(`note-text-${noteId}`);
                const newText = noteTextElement.value;
                const noteIndex = notes.findIndex(note => note.id === noteId);
                if (noteIndex !== -1) {
                    notes[noteIndex].text = newText;
                    saveNotes();
                    displayNotes();
                }
                editingNoteId = null;
            } else {
                // Start editing
                const noteTextElement = document.getElementById(`note-text-${noteId}`);
                const currentText = noteTextElement.textContent;
                noteTextElement.innerHTML = `<textarea class="form-control note-text editing">${currentText}</textarea>`;
                editingNoteId = noteId;
            }
        }

        function deleteNote(noteId) {
            if (confirm('Are you sure you want to delete this note?')) {
                notes = notes.filter(note => note.id !== noteId);
                saveNotes();
                displayNotes();
            }
        }

        // Voice recording functionality
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');

        recordBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const currentTime = player.getCurrentTime();
                    
                    // Add audio note
                    const note = {
                        id: Date.now(),
                        text: 'Voice Note',
                        time: currentTime,
                        timestamp: new Date().toISOString(),
                        audioUrl: audioUrl
                    };
                    notes.push(note);
                    saveNotes();
                    displayNotes();
                    
                    audioChunks = [];
                };

                mediaRecorder.start();
                isRecording = true;
                recordBtn.disabled = true;
                stopBtn.disabled = false;
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Error accessing microphone. Please ensure you have granted microphone permissions.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.disabled = false;
                stopBtn.disabled = true;
            }
        }

        // Local storage functionality
        function saveNotes() {
            localStorage.setItem('studyNotes', JSON.stringify(notes));
        }

        function loadNotes() {
            const savedNotes = localStorage.getItem('studyNotes');
            if (savedNotes) {
                notes = JSON.parse(savedNotes);
                displayNotes();
            }
        }

        // Load saved notes when page loads
        loadNotes();

        // Load notes on page load
        loadNotes();
        displayNotes();

        // Theme switching functionality
        const themeSwitch = document.getElementById('themeSwitch');

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            themeSwitch.checked = savedTheme === 'dark';
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        themeSwitch.addEventListener('change', toggleTheme);
        initTheme();

        // Performance tracking
        let startTime = Date.now();
        let studyTimeToday = parseInt(localStorage.getItem('studyTimeToday') || '0');
        let lastDate = localStorage.getItem('lastStudyDate');
        
        // Reset study time if it's a new day
        const today = new Date().toDateString();
        if (lastDate !== today) {
            studyTimeToday = 0;
            localStorage.setItem('lastStudyDate', today);
        }

        // Update performance metrics every minute
        setInterval(() => {
            // Update study time
            const currentTime = Date.now();
            const timeSpent = Math.floor((currentTime - startTime) / 60000); // Convert to minutes
            studyTimeToday += 1;
            localStorage.setItem('studyTimeToday', studyTimeToday.toString());
            document.getElementById('studyTimeToday').textContent = `${studyTimeToday} min`;

            // Update notes count
            document.getElementById('notesCount').textContent = notes.length.toString();
        }, 60000);

        // Tasks functionality
        let tasks = JSON.parse(localStorage.getItem('todayTasks') || '[]');
        const taskInput = document.getElementById('taskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const tasksList = document.getElementById('tasksList');

        function addTask(text) {
            const task = {
                id: Date.now(),
                text: text,
                completed: false,
                date: new Date().toDateString()
            };
            tasks.push(task);
            saveTasks();
            displayTasks();
            taskInput.value = '';
        }

        function toggleTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                saveTasks();
                displayTasks();
            }
        }

        function deleteTask(taskId) {
            tasks = tasks.filter(t => t.id !== taskId);
            saveTasks();
            displayTasks();
        }

        function saveTasks() {
            localStorage.setItem('todayTasks', JSON.stringify(tasks));
        }

        function displayTasks() {
            // Filter tasks for today
            const todayTasks = tasks.filter(task => task.date === new Date().toDateString());
            
            tasksList.innerHTML = '';
            todayTasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                taskElement.innerHTML = `
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                        ${task.completed ? '<i class="bi bi-check"></i>' : ''}
                    </div>
                    <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                    <i class="bi bi-trash task-delete" onclick="deleteTask(${task.id})"></i>
                `;
                tasksList.appendChild(taskElement);
            });
        }

        // Initialize tasks
        displayTasks();

        // Add task event listeners
        addTaskBtn.addEventListener('click', () => {
            const text = taskInput.value.trim();
            if (text) {
                addTask(text);
            }
        });

        taskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const text = taskInput.value.trim();
                if (text) {
                    addTask(text);
                }
            }
        });

        // Make functions available globally
        window.toggleTask = toggleTask;
        window.deleteTask = deleteTask;
    </script>
</body>
</html> 